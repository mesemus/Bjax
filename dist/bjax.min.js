define(["jquery"],function(t){function e(r,i){void 0===i&&a(r)&&(i=r,r=void 0),r=$(r),this.options=t.extend({},e.defaults,i||{}),this.data={},void 0!==r&&this.loadElement(r),this.loadData(),this.loader=new e.Loader(this.data.target),this.execute()}var r=function(t){return"[object Array]"===Object.prototype.toString.call(t)},a=function(e){return t.isPlainObject(e)},i=function(t){return r(t)?0===t.length:!t};return e.VERSION="1.0.2",e.defaults={url_attribute:["data-href","href"],replace_attribute:"data-replace",replace:!0,element_attribute:"data-el",element:"html",target_attribute:"data-target",target:"html",url_transformation:null},e.prototype.loadElement=function(t){var e={url:this.getValueByAttr(t,this.options.url_attribute),element:this.getValueByAttr(t,this.options.element_attribute),target:this.getValueByAttr(t,this.options.target_attribute),replace:this.getValueByAttr(t,this.options.replace_attribute)};for(var r in e)i(e[r])||(this.data[r]=e[r])},e.prototype.loadData=function(t){var e={url:this.options.url,element:this.options.element,target:this.options.target,replace:this.options.replace};for(var r in e)i(e[r])||r in this.data||(this.data[r]=e[r])},e.prototype.getValueByAttr=function(t,e){r(e)||(e=[e]);for(var a=0;a<e.length;a++){var i=t.attr(e[a]);if("undefined"!=typeof i&&i!==!1)return i}},e.prototype.execute=function(){var e=this;e.loader.update(100,500);var r=this.options.url_transformation?this.options.url_transformation(this.data.url):this.data.url;console.log("ajax-loading url",r),t.ajax({type:"GET",url:r,success:function(t){e.loader.update(100,300,function(){e.render(t),e.updateUrl(),document.title=$(t).filter("title").text()})},error:function(t,r,a){var i="Error occurred, retrying. Click anywhere to exit.";if("rejected"===t.state())var i="Gone offline, retrying. Click anywhere to exit.";e.loader.error(2e3,i,function(){e.execute()})}})},e.prototype.updateUrl=function(){if(this.data.replace===!0)try{window.history.pushState({path:window.location.href},"",this.data.url)}catch(t){console.error("history.pushState failed, maybe HTML5 is not supported?"),console.error(t.stack),window.location.replace(this.data.url)}},e.prototype.render=function(t){"html"!==this.data.element&&(t=$(t).find(this.data.element).html()),"html"!==this.data.target?$(this.data.target).html(t):(document.open(),document.write(t),document.close())},e.PercentLoader=function(t){this.target=$(t),this.backdrop=$('<div class="bjax-backdrop"></div>'),this.bar=$('<div class="bjax-bar"></div>'),this.err=$('<div class="bjax-backdrop-error"></div>'),this.abort=!1,this.init()},e.PercentLoader.prototype.init=function(){var t=this;this.target.css("position","relative"),this.backdrop.appendTo(this.target),this.bar.width(0),this.bar.appendTo(this.backdrop),this.err.appendTo(this.backdrop),$(document).on("click",".bjax-backdrop",function(){$(this).remove(),t.abort=!0,$(document).off("click",".bjax-backdrop")})},e.PercentLoader.prototype.update=function(t,e,r){this.bar.stop().animate({width:t+"%"},e,"linear",function(){void 0!==r&&r()})},e.PercentLoader.prototype.error=function(t,e,r){var a=this;this.bar.stop(),this.bar.width(0),this.bar.addClass("bjax-bar-error"),this.err.text(e),this.bar.animate({width:"100%"},t,"linear",function(){a.bar.width(0),a.bar.removeClass("bjax-bar-error"),void 0!==r&&a.abort===!1&&r()})},e.Loader=e.PercentLoader,t.fn.bjax=function(t){return $(document).on("click",this.selector,function(r){new e(this,t),r.preventDefault()}),this},$(window).bind("popstate",function(t){var r=t.originalEvent.state;r&&new e({url:r.path,replace:!1})}),history.replaceState({path:window.location.href},""),e});