define(["jquery"],function(t){function e(a,i){void 0===i&&r(a)&&(i=a,a=void 0),a=$(a),this.options=t.extend({},e.defaults,i||{}),this.data={},void 0!==a&&this.loadElement(a),this.loadData(),this.loader=new e.Loader(this.data.target),this.execute()}var a=function(t){return"[object Array]"===Object.prototype.toString.call(t)},r=function(e){return t.isPlainObject(e)},i=function(t){return a(t)?0===t.length:!t};return e.VERSION="1.0.2",e.defaults={url_attribute:["data-href","href"],replace_attribute:"data-replace",replace:!0,element_attribute:"data-el",element:"html",target_attribute:"data-target",target:"html",url_transformation:null,load_callback:null},e.prototype.loadElement=function(t){var e={url:this.getValueByAttr(t,this.options.url_attribute),element:this.getValueByAttr(t,this.options.element_attribute),target:this.getValueByAttr(t,this.options.target_attribute),replace:this.getValueByAttr(t,this.options.replace_attribute)};for(var a in e)i(e[a])||(this.data[a]=e[a])},e.prototype.loadData=function(t){var e={url:this.options.url,element:this.options.element,target:this.options.target,replace:this.options.replace};for(var a in e)i(e[a])||a in this.data||(this.data[a]=e[a])},e.prototype.getValueByAttr=function(t,e){a(e)||(e=[e]);for(var r=0;r<e.length;r++){var i=t.attr(e[r]);if("undefined"!=typeof i&&i!==!1)return i}},e.prototype.execute=function(){var e=this;e.loader.update(100,500);var a=this.options.url_transformation?this.options.url_transformation(this.data.url):this.data.url;t("body").addClass("waiting"),t.ajax({type:"GET",url:a,success:function(t){e.loader.update(100,300,function(){e.render(t),e.updateUrl(),document.title=$(t).filter("title").text(),e.options.load_callback&&e.options.load_callback(e,t)})},complete:function(){t("body").removeClass("waiting")},error:function(t,a,r){var i="Error occurred, retrying. Click anywhere to exit.";if("rejected"===t.state())var i="Gone offline, retrying. Click anywhere to exit.";e.loader.error(2e3,i,function(){e.execute()})}})},e.prototype.updateUrl=function(){if(this.data.replace===!0)try{window.history.pushState({path:window.location.href},"",this.data.url)}catch(t){console.error("history.pushState failed, maybe HTML5 is not supported?"),console.error(t.stack),window.location.replace(this.data.url)}},e.prototype.render=function(e){if("html"!==this.data.element){var a=this,r=(new DOMParser).parseFromString("<dummy/>","text/html"),i=t.parseHTML(t.trim(e),r,!0),o=[];i.forEach(function(t){var e=$(t).find(a.data.element).addBack(a.data.element);e.length>0&&o.push(e)}),e=o.length?o[0].html():"Element with signature "+a.data.element+" not found in data"}"html"!==this.data.target?$(this.data.target).html(e):(document.open(),document.write(e),document.close())},e.PercentLoader=function(t){this.target=$(t),this.backdrop=$('<div class="bjax-backdrop"></div>'),this.bar=$('<div class="bjax-bar"></div>'),this.err=$('<div class="bjax-backdrop-error"></div>'),this.abort=!1,this.init()},e.PercentLoader.prototype.init=function(){var t=this;this.target.css("position","relative"),this.backdrop.appendTo(this.target),this.bar.width(0),this.bar.appendTo(this.backdrop),this.err.appendTo(this.backdrop),$(document).on("click",".bjax-backdrop",function(){$(this).remove(),t.abort=!0,$(document).off("click",".bjax-backdrop")})},e.PercentLoader.prototype.update=function(t,e,a){this.bar.stop().animate({width:t+"%"},e,"linear",function(){void 0!==a&&a()})},e.PercentLoader.prototype.error=function(t,e,a){var r=this;this.bar.stop(),this.bar.width(0),this.bar.addClass("bjax-bar-error"),this.err.text(e),this.bar.animate({width:"100%"},t,"linear",function(){r.bar.width(0),r.bar.removeClass("bjax-bar-error"),void 0!==a&&r.abort===!1&&a()})},e.Loader=e.PercentLoader,t.fn.bjax=function(t){return $(document).on("click",this.selector,function(a){new e(this,t),a.preventDefault()}),this},$(window).bind("popstate",function(t){var a=t.originalEvent.state;a&&new e({url:a.path,replace:!1})}),history.replaceState({path:window.location.href},""),e});